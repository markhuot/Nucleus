<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html;charset=utf-8"><title>NucleusResult.php</title><link rel="stylesheet" href="docco.css"><script src="http://code.jquery.com/jquery-1.7.1.min.js"></script><script src="https://raw.github.com/coreyti/showdown/master/src/showdown.js"></script><link href="http://google-code-prettify.googlecode.com/svn/trunk/src/prettify.css" type="text/css" rel="stylesheet" /><!--script type="text/javascript" src="http://google-code-prettify.googlecode.com/svn/trunk/src/prettify.js"--></script><link href="http://alexgorbatchev.com/pub/sh/current/styles/shThemeDefault.css" rel="stylesheet" type="text/css" /><style type="text/css">.syntaxhighlighter,.syntaxhighlighter .line.alt1,.syntaxhighlighter .line.alt2{background:none !important;} td.code td.code {padding:0;border:none;}</style></head><body><div id="container"><div id="background"></div><div id="jump_to"><a id="jump_handle" href="#">Jump To &hellip;</a><div id="jump_wrapper"><div id="jump_page"><a class="source" href="Nucleus.php.html">Nucleus.php</a><a class="source" href="NucleusAnonymousModel.php.html">NucleusAnonymousModel.php</a><a class="source" href="NucleusConnection.php.html">NucleusConnection.php</a><a class="source" href="NucleusHelper.php.html">NucleusHelper.php</a><a class="source" href="NucleusJoin.php.html">NucleusJoin.php</a><a class="source" href="NucleusJoinMany.php.html">NucleusJoinMany.php</a><a class="source" href="NucleusJoinManyMany.php.html">NucleusJoinManyMany.php</a><a class="source" href="NucleusJoinOne.php.html">NucleusJoinOne.php</a><a class="source" href="NucleusModel.php.html">NucleusModel.php</a><a class="source" href="NucleusQuery.php.html">NucleusQuery.php</a><a class="source" href="NucleusRecord.php.html">NucleusRecord.php</a><a class="source" href="NucleusResult.php.html">NucleusResult.php</a><a class="source" href="config.php.html">config.php</a></div></div></div><table cellspacing=0 cellpadding=0><thead><tr><th class=docs><h1>NucleusResult.php</h1></th><th class=code></th></tr></thead><tbody><tr id="section-0"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-0">&#182;</a></div><div class="doc"> Our namespace…</div></td><td class="code"><div class="highlight"><pre class="brush: php">namespace Nucleus;</pre></div></td></tr><tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div><div class="doc">
The class, which implements an Iterator so we can loop over each record in
a `foreach` loop.
 </div></td><td class="code"><div class="highlight"><pre class="brush: php">class Result implements \Iterator {</pre></div></td></tr><tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><div class="doc">
The index of the iterator as we loop over the records.
	 </div></td><td class="code"><div class="highlight"><pre class="brush: php">	private $index = 0;</pre></div></td></tr><tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><div class="doc">
Stores each record this result set is responsible for. It is stored in a
nested fashion like this:

    $records = array(
        [t0] = array(                         // The table name
            [id] = array(                     // The related table key
                [null] = array(               // The related table id
                    [12] = Nucleus_record     // The related object
                    [9] = Nucleus_record      // The key maps to the...
                    [2] = Nucleus_record,     // ..object's primary key
                )
            )
        ), 
        [t1] = array(                         // Stored by the table id
            [post_id] = array(
                [3] = array(
                    [12] = Nucleus_record,
                    [9] = Nucleus_record,
                    [2] = Nucleus_record,
                )
            )
        ),
        [t2] = array(
            [post_id] = array(
                [3] = array(
                    [1] Nucleus_record,
                    [2] Nucleus_record,
                    [3] Nucleus_record,
                )
            )
        )
    )
	 </div></td><td class="code"><div class="highlight"><pre class="brush: php">	private $records = array();</pre></div></td></tr><tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><div class="doc">
The query that generated this result set. This is useful because it
defines how JOINs were added and what identifiers table names were
mapped to.
	 </div></td><td class="code"><div class="highlight"><pre class="brush: php">	private $query;</pre></div></td></tr><tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><div class="doc">
Each relation has one, and only one, primary table. It is this table
that we iterate over and this table that drives all the relations. In
the sample query `SELECTFROM posts LEFT JOIN post_data…` the primary
table would be the `posts` table.
	 </div></td><td class="code"><div class="highlight"><pre class="brush: php">	private $table = 't0';</pre></div></td></tr><tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><div class="doc">
The key defines how related tables are joined onto the primary table.
In the $records array this is the second level key. It defaults to `id`
as a way to index the primary table.
	 </div></td><td class="code"><div class="highlight"><pre class="brush: php">	private $key = 'id';</pre></div></td></tr><tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><div class="doc">
The ID is the way related tables are joined onto the primary table. By
default we set this to null.
	 </div></td><td class="code"><div class="highlight"><pre class="brush: php">	private $id = 'null';</pre></div></td></tr><tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><div class="doc">
Accepts the rows to parse and the query that generated this result.
	 </div></td><td class="code"><div class="highlight"><pre class="brush: php">	public function __construct($query=FALSE, $rows=array()) {
		$this-&gt;query = $query;
		$this-&gt;table = $query-&gt;primary_table();
		foreach ($rows as $row) {
			$records_in_row = $this-&gt;parse_row_to_records($row);
			foreach ($records_in_row as $record) {
				$this-&gt;add_record($record);
			}
		}
	}</pre></div></td></tr><tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><div class="doc">
When a result set is cloned, possibly to reference related entries we
want to make sure certain properties are reset.
	 </div></td><td class="code"><div class="highlight"><pre class="brush: php">	public function __clone() {
		$defaults = (object)get_class_vars('Nucleus\Result');
		$this-&gt;index = $defaults-&gt;index;
	}</pre></div></td></tr><tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><div class="doc">
Parses a raw database result and turns it into actual records. The raw
database result would be an array with column names mapping to one or
more tables. This method takes each column, determines which table or
record it references and adds it to the appropriate record.
This is called from the __constructor and probably won't need to be
called publically on the object.
	 </div></td><td class="code"><div class="highlight"><pre class="brush: php">	private function parse_row_to_records($row) {</pre></div></td></tr><tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><div class="doc"> We'll store each record contained in this row here</div></td><td class="code"><div class="highlight"><pre class="brush: php">		$records = array();</pre></div></td></tr><tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><div class="doc"> Loop through each column in the row to determine which table
it belongs to.
		 </div></td><td class="code"><div class="highlight"><pre class="brush: php">		foreach ($row as $key =&gt; $value) {</pre></div></td></tr><tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><div class="doc"> Explode the column name to determine the table name. So, a
column name of `posts.title` will be from the table `posts` and
have a column name of `title`.
			 </div></td><td class="code"><div class="highlight"><pre class="brush: php">			list($table_identifier, $column) = explode('.', $key);
			</pre></div></td></tr><tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><div class="doc"> If this is the first column from the determined table create
a new database record to hold it.
			 </div></td><td class="code"><div class="highlight"><pre class="brush: php">			if (!@$records[$table_identifier]) {
				$records[$table_identifier] = new Record(
					$this,
					Model::for_identifier($table_identifier)
				);
			}</pre></div></td></tr><tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><div class="doc"> Finally, add the column and its value to the appropriate
database record
			 </div></td><td class="code"><div class="highlight"><pre class="brush: php">			$records[$table_identifier]-&gt;set_data($column, $value);
		}</pre></div></td></tr><tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><div class="doc">
Loop through each record and remove records that don't have a PK
since they're probably just artifacts of the join. This happens when
you SELECTFROM posts LEFT JOIN comments. If a post has no
comments the comment table columns will still be returned but
instead of having any data in them they will all be null.
		 </div></td><td class="code"><div class="highlight"><pre class="brush: php">		foreach ($records as &amp;$record) {
			if (!$record-&gt;id()) {
				$record = null;
			}
		}</pre></div></td></tr><tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><div class="doc"> Return the array of non-null records contained in this row</div></td><td class="code"><div class="highlight"><pre class="brush: php">		return array_filter($records);
	}</pre></div></td></tr><tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><div class="doc">
Adds a record to the result set. If the record contains any foreign keys
we'll add it to the result set mutliple times for each foreign key.
	 </div></td><td class="code"><div class="highlight"><pre class="brush: php">	public function add_record($record) {</pre></div></td></tr><tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><div class="doc"> Setup the defaults</div></td><td class="code"><div class="highlight"><pre class="brush: php">		$table_identifier = $record-&gt;table_identifier();
		$key = $this-&gt;key;
		$id = $this-&gt;id;</pre></div></td></tr><tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><div class="doc">
Check if this record is the primary record or joined on via a
relationship.
		 </div></td><td class="code"><div class="highlight"><pre class="brush: php">		if ($config = $this-&gt;query-&gt;join_for($record-&gt;model())) {
			$key = $config-&gt;foreign_key;
			$id = $record-&gt;{$key};
		}</pre></div></td></tr><tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><div class="doc"> Store the record</div></td><td class="code"><div class="highlight"><pre class="brush: php">		$this-&gt;records[$table_identifier][$key][$id][$record-&gt;id()] = $record;
	}</pre></div></td></tr><tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><div class="doc">
Access to the query that generated this result
	 </div></td><td class="code"><div class="highlight"><pre class="brush: php">	public function query() {
		return $this-&gt;query;
	}</pre></div></td></tr><tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><div class="doc">
Returns the currently focused collection.
	 </div></td><td class="code"><div class="highlight"><pre class="brush: php">	public function records() {
		return @$this-&gt;records
			[$this-&gt;table-&gt;identifier()]
			[$this-&gt;key]
			[$this-&gt;id];
	}</pre></div></td></tr><tr id="section-24"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-24">&#182;</a></div><div class="doc">
Returns the record in question. You can ask for a record by
index (0,1,2,3…) which will return the actual Nucleus_record or you
can ask for a string "title" or "body" to return the value of the 
column in the first record.
	 </div></td><td class="code"><div class="highlight"><pre class="brush: php">	public function record($key) {
		$collection = $this-&gt;records();
		$keys = array_keys($collection);
		if (is_string($key)) {
			return @$collection[$keys[0]]-&gt;{$key};
		}
		else {
			return @$collection[$keys[$key]];
		}
	}</pre></div></td></tr><tr id="section-25"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-25">&#182;</a></div><div class="doc">
If a relation exists at the defined key it is returned, otherwise
FALSE is returned.
	 </div></td><td class="code"><div class="highlight"><pre class="brush: php">	public function related($record, $name) {
		if (!($config = $this-&gt;query-&gt;join_for($record-&gt;model(), $name))) {
			return FALSE;
		}
		$table = $config-&gt;foreign_table;
		$key = $config-&gt;foreign_key;
		$id = $record-&gt;{$config-&gt;primary_key};
		if (isset($this-&gt;records[$table-&gt;identifier()][$key][$id])) {
			$result = clone $this;
			$result-&gt;table = $config-&gt;foreign_table;
			$result-&gt;key = $key;
			$result-&gt;id = $id;
			if (get_class($config) == 'Nucleus\JoinOne') {
				return $result-&gt;record(0);
			}
			else {
				return $result;
			}
		}
		return FALSE;
	}</pre></div></td></tr><tr id="section-26"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-26">&#182;</a></div><div class="doc">
Returns the number of rows in this result set.
	 </div></td><td class="code"><div class="highlight"><pre class="brush: php">	public function size() {
		return count($this-&gt;records());
	}</pre></div></td></tr><tr id="section-27"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-27">&#182;</a></div><div class="doc">
## Iterators

The required methods to iterate over an object. The trickery going on
here involves our $records array being indexed by primary key and not
incrementing numerically. So, for each of these we have to get our
array of keys and apply our index to the array of keys instead of just
using `$this->records` actual keys.
	 </div></td><td class="code"><div class="highlight"><pre class="brush: php">	public function key() {
		return $this-&gt;index;
	}
	public function current() {
		return $this-&gt;record($this-&gt;index);
	}
	function next() {
		return $this-&gt;record(++$this-&gt;index)?:FALSE;
	}
	function valid() {
		return $this-&gt;record($this-&gt;index)?TRUE:FALSE;
	}
	function rewind() {
		return $this-&gt;record($this-&gt;index = 0);
	}
}
</pre></div></td></tr></table></div><script>converter = new Showdown.converter();$(".doc").each(function() { $(this).html(converter.makeHtml($(this).text())); }); $("#jump_handle").click(function(e){ $("#jump_wrapper").toggle(); e.preventDefault(); }); </script><script src="https://raw.github.com/alexgorbatchev/SyntaxHighlighter/master/scripts/XRegExp.js"></script><script src="https://raw.github.com/alexgorbatchev/SyntaxHighlighter/master/scripts/shCore.js" type="text/javascript"></script><script src="http://alexgorbatchev.com/pub/sh/current/scripts/shAutoloader.js" type="text/javascript"></script><script type="text/javascript">
function path()
{
  var args = arguments,
      result = []
      ;
       
  for(var i = 0; i < args.length; i++)
      result.push(args[i].replace("@", "http://alexgorbatchev.com/pub/sh/current/scripts/"));
       
  return result
};

SyntaxHighlighter.autoloader.apply(null, path(
  "applescript            @shBrushAppleScript.js",
  "actionscript3 as3      @shBrushAS3.js",
  "bash shell             @shBrushBash.js",
  "coldfusion cf          @shBrushColdFusion.js",
  "cpp c                  @shBrushCpp.js",
  "c# c-sharp csharp      @shBrushCSharp.js",
  "css                    @shBrushCss.js",
  "delphi pascal          @shBrushDelphi.js",
  "diff patch pas         @shBrushDiff.js",
  "erl erlang             @shBrushErlang.js",
  "groovy                 @shBrushGroovy.js",
  "java                   @shBrushJava.js",
  "jfx javafx             @shBrushJavaFX.js",
  "js jscript javascript  @shBrushJScript.js",
  "perl pl                @shBrushPerl.js",
  "php                    @shBrushPhp.js",
  "text plain             @shBrushPlain.js",
  "py python              @shBrushPython.js",
  "ruby rails ror rb      @shBrushRuby.js",
  "sass scss              @shBrushSass.js",
  "scala                  @shBrushScala.js",
  "sql                    @shBrushSql.js",
  "vb vbnet               @shBrushVb.js",
  "xml xhtml xslt html    @shBrushXml.js"
));
SyntaxHighlighter.defaults["light"] = true;
SyntaxHighlighter.defaults["unindent"] = false;
SyntaxHighlighter.all();
	</script></body>