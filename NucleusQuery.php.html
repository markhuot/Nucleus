<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html;charset=utf-8"><title>NucleusQuery.php</title><link rel="stylesheet" href="docco.css"><script src="http://code.jquery.com/jquery-1.7.1.min.js"></script><script src="https://raw.github.com/coreyti/showdown/master/src/showdown.js"></script><link href="http://google-code-prettify.googlecode.com/svn/trunk/src/prettify.css" type="text/css" rel="stylesheet" /><!--script type="text/javascript" src="http://google-code-prettify.googlecode.com/svn/trunk/src/prettify.js"--></script><link href="http://alexgorbatchev.com/pub/sh/current/styles/shThemeDefault.css" rel="stylesheet" type="text/css" /><style type="text/css">.syntaxhighlighter,.syntaxhighlighter .line.alt1,.syntaxhighlighter .line.alt2{background:none !important;} td.code td.code {padding:0;border:none;}</style></head><body><div id="container"><div id="background"></div><div id="jump_to"><a id="jump_handle" href="#">Jump To &hellip;</a><div id="jump_wrapper"><div id="jump_page"><a class="source" href="Nucleus.php.html">Nucleus.php</a><a class="source" href="NucleusAnonymousModel.php.html">NucleusAnonymousModel.php</a><a class="source" href="NucleusConnection.php.html">NucleusConnection.php</a><a class="source" href="NucleusHelper.php.html">NucleusHelper.php</a><a class="source" href="NucleusJoin.php.html">NucleusJoin.php</a><a class="source" href="NucleusJoinMany.php.html">NucleusJoinMany.php</a><a class="source" href="NucleusJoinManyMany.php.html">NucleusJoinManyMany.php</a><a class="source" href="NucleusJoinOne.php.html">NucleusJoinOne.php</a><a class="source" href="NucleusModel.php.html">NucleusModel.php</a><a class="source" href="NucleusQuery.php.html">NucleusQuery.php</a><a class="source" href="NucleusRecord.php.html">NucleusRecord.php</a><a class="source" href="NucleusResult.php.html">NucleusResult.php</a><a class="source" href="config.php.html">config.php</a></div></div></div><table cellspacing=0 cellpadding=0><thead><tr><th class=docs><h1>NucleusQuery.php</h1></th><th class=code></th></tr></thead><tbody><tr id="section-0"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-0">&#182;</a></div><div class="doc"></div></td><td class="code"><div class="highlight"><pre class="brush: php">namespace Nucleus;
class Query {
	private $connection;
	private $queries = array();       // Each query run by this object
	private $select = array();        // The requested selections
	private $from = array();          // The primary table to pull from
	private $joins = array();         // The requested joins (indexed by name)
	private $where = array();         // Any defined where statements
	private $orderby = array();       // The requested order</pre></div></td></tr><tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div><div class="doc"> ------------------------------------------------------------------------</div></td><td class="code"><div class="highlight"><pre class="brush: php">	public function __construct($connection=FALSE) {
		$this-&gt;connection = $connection ?: Connection::active();
		$this-&gt;reset();
	}</pre></div></td></tr><tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><div class="doc"> ------------------------------------------------------------------------</div></td><td class="code"><div class="highlight"><pre class="brush: php">	public function connection() {
		return $this-&gt;connection;
	}</pre></div></td></tr><tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><div class="doc"> ------------------------------------------------------------------------</div></td><td class="code"><div class="highlight"><pre class="brush: php">	public function reset() {
		$defaults = (object)get_class_vars('\Nucleus\Query');
		$this-&gt;select = $defaults-&gt;select;
		$this-&gt;from = $defaults-&gt;from;
		$this-&gt;joins = $defaults-&gt;joins;
		$this-&gt;where = $defaults-&gt;where;
		$this-&gt;orderby = $defaults-&gt;orderby;
	}</pre></div></td></tr><tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><div class="doc"> ------------------------------------------------------------------------</div></td><td class="code"><div class="highlight"><pre class="brush: php">	public function select($key) {
		if (is_array($key)) {
			foreach ($key as $k) {
				$this-&gt;select($k);
			}
		}
		else if (is_string($key) &amp;&amp; $key !== '*') {
			$this-&gt;select[] = $key;
		}
		return $this;
	}
	public function build_select() {
		$select = array();</pre></div></td></tr><tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><div class="doc"> Required selects are the primary and foreign key fields which help</div></td><td class="code"><div class="highlight"><pre class="brush: php"></pre></div></td></tr><tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><div class="doc"> us identify how tables are related. These are added in no</div></td><td class="code"><div class="highlight"><pre class="brush: php"></pre></div></td></tr><tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><div class="doc"> matter what.</div></td><td class="code"><div class="highlight"><pre class="brush: php">		foreach ($this-&gt;from as $model) {
			$select[] = $model-&gt;sql_select();
		}
		foreach ($this-&gt;joins as $join) {
			$select[] = $join-&gt;sql_select();
		}</pre></div></td></tr><tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><div class="doc"> User defined selects can either be * or an array of fields. We</div></td><td class="code"><div class="highlight"><pre class="brush: php"></pre></div></td></tr><tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><div class="doc"> really don't care what they're selecting since we know the preious</div></td><td class="code"><div class="highlight"><pre class="brush: php"></pre></div></td></tr><tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><div class="doc"> section has us covered.</div></td><td class="code"><div class="highlight"><pre class="brush: php">		foreach ($this-&gt;tables() as $model) {
			$table = $model-&gt;table_name();
			$identifier = $model-&gt;identifier();
			$columns = $this-&gt;query(&quot;DESCRIBE {$table}&quot;);
			if (!$columns) {
				throw new \Exception(
					'Could not build SELECT, invalid table specified',
					500
				);
			}
			foreach($columns as $column) {
				$field = $column['Field'];
				if (!$this-&gt;select ||
				    in_array($field, $this-&gt;select) ||
				    in_array(&quot;{$table}.*&quot;, $this-&gt;select) ||
				    in_array(&quot;{$table}.{$field}&quot;, $this-&gt;select)) {
					$select[] = &quot;{$identifier}.{$field} AS `{$identifier}.{$field}`&quot;;
				}
			}
		}
		return ' SELECT '.implode(', ', array_unique($select));
	}</pre></div></td></tr><tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><div class="doc"> ------------------------------------------------------------------------</div></td><td class="code"><div class="highlight"><pre class="brush: php"></pre></div></td></tr><tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><div class="doc">
From
	 *
Sets the FROM part of the SQL query. Input can be accepted in a number
of ways:
  1. from('posts') passing in, simply, the table you're looking for
  2. from('users', 'assigned') with two parameters, passing in an
     optional table alias
  3. from('posts as p') with the alias assigned within the string
  4. from('posts, users, comments') passing in the primary table first,
     followed by optional join tables
	 </div></td><td class="code"><div class="highlight"><pre class="brush: php">	public function from($table, $alias=FALSE) {</pre></div></td></tr><tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><div class="doc"> Check if we're passing in multiple tables. If so split it out and</div></td><td class="code"><div class="highlight"><pre class="brush: php"></pre></div></td></tr><tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><div class="doc"> join on any subsequent tables.</div></td><td class="code"><div class="highlight"><pre class="brush: php">		if (strpos($table, ',')) {
			$tables = preg_split('/\s*,\s*/', $table);
			$this-&gt;from(array_shift($tables));
			foreach ($tables as $table) {
				$this-&gt;join($table);
			}
			return $this;
		}</pre></div></td></tr><tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><div class="doc"> Check if we're setting the alias within the string</div></td><td class="code"><div class="highlight"><pre class="brush: php">		if (preg_match('/^(.*)\s+as\s+(.*)$/i', $table, $matches)) {
			$table = $matches[1];
			$alias = $matches[2];
		}</pre></div></td></tr><tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><div class="doc"> Convert the table to a model and add it to our array of from tables</div></td><td class="code"><div class="highlight"><pre class="brush: php">		$this-&gt;from[] = Model::for_table($table, $alias, TRUE);
		return $this;
	}
	public function build_from() {
		$sql = ' FROM ';
		foreach ($this-&gt;from as $model) {
			$sql.= &quot;{$model-&gt;table_name()} AS {$model-&gt;identifier()}, &quot;;
		}
		return rtrim($sql, ', ');
	}</pre></div></td></tr><tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><div class="doc"> ------------------------------------------------------------------------</div></td><td class="code"><div class="highlight"><pre class="brush: php">	public function join() {
		if (func_num_args() == 1 &amp;&amp; is_array(func_get_arg(0))) {
			$join = func_get_arg(0);
		}
		else if (func_num_args() == 1 &amp;&amp; is_string(func_get_arg(0))) {
			$join = array(
				'foreign_table' =&gt; func_get_arg(0)
			);
		}
		else if (func_num_args() == 2) {
			$join = array_merge(array(
				'foreign_table' =&gt; func_get_arg(0)
			), func_get_arg(1));
		}
		$this-&gt;joins[] = $join;
		return $this;
	}
	public function prep_joins() {
		foreach ($this-&gt;joins as &amp;$c) {</pre></div></td></tr><tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><div class="doc"> Check that the join hasn't already been converted to an</div></td><td class="code"><div class="highlight"><pre class="brush: php"></pre></div></td></tr><tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><div class="doc"> object. If it has, bail out, no need to do it again.</div></td><td class="code"><div class="highlight"><pre class="brush: php">			if (!is_array($c)) {
				continue;
			}</pre></div></td></tr><tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><div class="doc"> Pass our connection through to the Join. It'll need it to</div></td><td class="code"><div class="highlight"><pre class="brush: php"></pre></div></td></tr><tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><div class="doc"> confirm whether the join fields are valid.</div></td><td class="code"><div class="highlight"><pre class="brush: php">			$c['connection'] = $this-&gt;connection;
			</pre></div></td></tr><tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><div class="doc"> Determine the tables we're trying to relate here. This parses</div></td><td class="code"><div class="highlight"><pre class="brush: php"></pre></div></td></tr><tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><div class="doc"> the string for the following attributes:</div></td><td class="code"><div class="highlight"><pre class="brush: php"></pre></div></td></tr><tr id="section-24"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-24">&#182;</a></div><div class="doc">     [primary_table].[foreign_table] as [alias]</div></td><td class="code"><div class="highlight"><pre class="brush: php">			$regex = '/^(?:(.*)\.)?(.*?)(?:\s+?as\s+(.*))?$/i';
			preg_match($regex, $c['foreign_table'], $matches);</pre></div></td></tr><tr id="section-25"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-25">&#182;</a></div><div class="doc"> Check if we define the primary table in the string.</div></td><td class="code"><div class="highlight"><pre class="brush: php">			if ($matches[1]) {
				$c['primary_table'] = $this-&gt;model_for_table_name(trim($matches[1]));
			}</pre></div></td></tr><tr id="section-26"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-26">&#182;</a></div><div class="doc"> If the primary table isn't set in the string, set it to the</div></td><td class="code"><div class="highlight"><pre class="brush: php"></pre></div></td></tr><tr id="section-27"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-27">&#182;</a></div><div class="doc"> primary table of this query</div></td><td class="code"><div class="highlight"><pre class="brush: php">			else {
				$c['primary_table'] = $this-&gt;primary_table();
			}</pre></div></td></tr><tr id="section-28"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-28">&#182;</a></div><div class="doc"> Set the foreign table. There has to be a foreign table or there</div></td><td class="code"><div class="highlight"><pre class="brush: php"></pre></div></td></tr><tr id="section-29"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-29">&#182;</a></div><div class="doc"> isn't really a join, is there?</div></td><td class="code"><div class="highlight"><pre class="brush: php">			$c['foreign_table'] = $matches[2];</pre></div></td></tr><tr id="section-30"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-30">&#182;</a></div><div class="doc"> If we're passing in an alias via the string, set it here</div></td><td class="code"><div class="highlight"><pre class="brush: php">			if (isset($matches[3]) &amp;&amp; $matches[3]) {
				$c['as'] = @$matches[3];
			}</pre></div></td></tr><tr id="section-31"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-31">&#182;</a></div><div class="doc"> Check if we're referring to a defined relationship on the</div></td><td class="code"><div class="highlight"><pre class="brush: php"></pre></div></td></tr><tr id="section-32"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-32">&#182;</a></div><div class="doc"> primary model.</div></td><td class="code"><div class="highlight"><pre class="brush: php">			if ($config = $c['primary_table']-&gt;join_named($c['foreign_table'])) {
				$c = array_merge($c, $config);
			}</pre></div></td></tr><tr id="section-33"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-33">&#182;</a></div><div class="doc"> Turn our foreign_table string into a model.</div></td><td class="code"><div class="highlight"><pre class="brush: php"></pre></div></td></tr><tr id="section-34"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-34">&#182;</a></div><div class="doc"> Note: this shouldn't use the `model_for_table_name` method</div></td><td class="code"><div class="highlight"><pre class="brush: php"></pre></div></td></tr><tr id="section-35"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-35">&#182;</a></div><div class="doc"> because we don't ever want to "reuse" a model. The foreign</div></td><td class="code"><div class="highlight"><pre class="brush: php"></pre></div></td></tr><tr id="section-36"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-36">&#182;</a></div><div class="doc"> table is always a new table to this query so it should always</div></td><td class="code"><div class="highlight"><pre class="brush: php"></pre></div></td></tr><tr id="section-37"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-37">&#182;</a></div><div class="doc"> generate a new model.</div></td><td class="code"><div class="highlight"><pre class="brush: php">			if (is_string($c['foreign_table'])) {
				$c['foreign_table'] = Model::for_table($c['foreign_table'], $c['as']);
			}</pre></div></td></tr><tr id="section-38"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-38">&#182;</a></div><div class="doc"> Finally, check if this is actually a valid join?</div></td><td class="code"><div class="highlight"><pre class="brush: php">			if (($join = JoinOne::check($c)) !== FALSE || 
			    ($join = JoinMany::check($c)) !== FALSE || 
			    ($join = JoinManyMany::check($c)) !== FALSE) {
				$c = $join;
			}
			else {
				$c = NULL;
			}
		}</pre></div></td></tr><tr id="section-39"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-39">&#182;</a></div><div class="doc"> Clear out invalid joins</div></td><td class="code"><div class="highlight"><pre class="brush: php">		$this-&gt;joins = array_filter($this-&gt;joins);
	}
	public function build_joins() {
		$sql = '';
		foreach ($this-&gt;joins as $join) {
			$sql.= $join-&gt;sql_join();
		}
		return $sql;
	}</pre></div></td></tr><tr id="section-40"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-40">&#182;</a></div><div class="doc"> ------------------------------------------------------------------------</div></td><td class="code"><div class="highlight"><pre class="brush: php">	public function where($key, $value) {
		if (func_num_args() == 2) {
			$key = func_get_arg(0);
			$operator = '=';
			$value = func_get_arg(1);
		}
		if (func_num_args() == 3) {
			$key = func_get_arg(0);
			$operator = func_get_arg(1);
			$value = func_get_arg(2);
		}
		if ($value === TRUE) { $value = 1; }
		if ($value === FALSE) { $value = 0; }
		if ($value === NULL) { $value = 'NULL'; }
		$this-&gt;where[$key] = array(
			'key' =&gt; $key,
			'operator' =&gt; $operator,
			'value' =&gt; $value
		);
		return $this;
	}
	public function build_where() {
		$sql = '';
		if ($this-&gt;where) {
			$sql.= ' WHERE ';
			foreach ($this-&gt;where as $key =&gt; $w) {
				$sql.= &quot;{$key} {$w['operator']} :{$key}&quot;;
			}
		}
		return $sql;
	}
	public function build_where_parameters() {
		$where = array();
		foreach ($this-&gt;where as $key =&gt; $w) {
			$where[$key] = $w['value'];
		}
		return $where;
	}</pre></div></td></tr><tr id="section-41"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-41">&#182;</a></div><div class="doc"> ------------------------------------------------------------------------</div></td><td class="code"><div class="highlight"><pre class="brush: php">	public function orderby($key, $sort='asc') {
		$this-&gt;orderby[] = &quot;{$key} {$sort}&quot;;
		return $this;
	}
	public function build_orderby() {
		$sql = '';
		if ($this-&gt;orderby) {
			$sql.= ' ORDER BY ';
			$sql.= implode(', ', $this-&gt;orderby);
		}
		return $sql;
	}</pre></div></td></tr><tr id="section-42"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-42">&#182;</a></div><div class="doc"> ------------------------------------------------------------------------</div></td><td class="code"><div class="highlight"><pre class="brush: php">	public function get($table) {
		return $this-&gt;from($table)-&gt;go();
	}</pre></div></td></tr><tr id="section-43"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-43">&#182;</a></div><div class="doc"> ------------------------------------------------------------------------</div></td><td class="code"><div class="highlight"><pre class="brush: php">	private function _build_query() {
		$this-&gt;prep_joins();
		$sql = $this-&gt;build_select();
		$sql.= $this-&gt;build_from();
		$sql.= $this-&gt;build_joins();
		$sql.= $this-&gt;build_where();
		$sql.= $this-&gt;build_orderby();
		
		return trim($sql);
	}
	public function go() {
		$rows = $this-&gt;query();
		$result = new Result(
			clone $this,
			$rows
		);
		$this-&gt;reset();
		return $result;
	}
	private function query($sql=FALSE) {
		if (!$sql) {
			$sql = $this-&gt;_build_query();
		}
		return $this-&gt;connection-&gt;query(
			$this-&gt;queries[] = $sql,
			$this-&gt;build_where_parameters()
		)-&gt;fetchAll(\PDO::FETCH_ASSOC);
	}</pre></div></td></tr><tr id="section-44"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-44">&#182;</a></div><div class="doc"> ------------------------------------------------------------------------</div></td><td class="code"><div class="highlight"><pre class="brush: php">	public function primary_table() {
		$keys = array_keys($this-&gt;from);
		return @$this-&gt;from[$keys[0]]?:FALSE;
	}
	public function tables() {
		$tables = array();
		foreach ($this-&gt;from as $model) {
			$tables[] = $model;
		}
		foreach ($this-&gt;joins as $join) {
			$tables[] = $join-&gt;foreign_table;
		}
		return $tables;
	}</pre></div></td></tr><tr id="section-45"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-45">&#182;</a></div><div class="doc">
Model for Table Name
	 *
Checks through all the existing models to see if there is a model
matching the requested table name.
	 </div></td><td class="code"><div class="highlight"><pre class="brush: php">	public function model_for_table_name($table_name) {
		if (strpos($table_name, '.')) {
			return $this-&gt;model_for_table_path($table_name);
		}
		foreach ($this-&gt;tables() as $model) {
			if ($model-&gt;table_name() == $table_name ||
			    $model-&gt;alias() == $table_name) {
				return $model;
			}
		}
		throw new \Exception('You\'ve specified a table that doesn\'t exist: '.$table_name, 500);
	}</pre></div></td></tr><tr id="section-46"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-46">&#182;</a></div><div class="doc">
Model for Table Path
	 *
Takes a dot notation path of tables and determines the appropriate model
for the right most table.
	 </div></td><td class="code"><div class="highlight"><pre class="brush: php">	public function model_for_table_path($path) {</pre></div></td></tr><tr id="section-47"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-47">&#182;</a></div><div class="doc"> Explode out our string</div></td><td class="code"><div class="highlight"><pre class="brush: php">		$tables = preg_split('/\./', $path);</pre></div></td></tr><tr id="section-48"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-48">&#182;</a></div><div class="doc"> Find the initial model for the furthese left table</div></td><td class="code"><div class="highlight"><pre class="brush: php">		$primary_table = $this-&gt;model_for_table_name(array_shift($tables));</pre></div></td></tr><tr id="section-49"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-49">&#182;</a></div><div class="doc"> Loop through subsequent tables</div></td><td class="code"><div class="highlight"><pre class="brush: php">		foreach ($tables as $table) {</pre></div></td></tr><tr id="section-50"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-50">&#182;</a></div><div class="doc"> Get the join specified by the two tables</div></td><td class="code"><div class="highlight"><pre class="brush: php">			$join = $this-&gt;join_for($primary_table, $table);</pre></div></td></tr><tr id="section-51"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-51">&#182;</a></div><div class="doc"> Make the right table (the foreign_table) the new</div></td><td class="code"><div class="highlight"><pre class="brush: php"></pre></div></td></tr><tr id="section-52"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-52">&#182;</a></div><div class="doc"> primary table in our loop</div></td><td class="code"><div class="highlight"><pre class="brush: php">			$primary_table = $join-&gt;foreign_table;
		}</pre></div></td></tr><tr id="section-53"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-53">&#182;</a></div><div class="doc"> Finally update the primary table</div></td><td class="code"><div class="highlight"><pre class="brush: php">		return $primary_table;
	}</pre></div></td></tr><tr id="section-54"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-54">&#182;</a></div><div class="doc">
Join For
	 *
Returns the join config for specified parameters. Two results are
possible:
  1. Passed a $model the method returns the join config used to attach
     the table represented by $model
  2. Passed a $name as well, the method returns the join used to attach
     the table represented by $name.
	 </div></td><td class="code"><div class="highlight"><pre class="brush: php">	public function join_for($model, $name=FALSE) {
		$identifier = $model-&gt;identifier();
		foreach ($this-&gt;joins as $join) {</pre></div></td></tr><tr id="section-55"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-55">&#182;</a></div><div class="doc"> This method could be called while we're building the actual join</div></td><td class="code"><div class="highlight"><pre class="brush: php"></pre></div></td></tr><tr id="section-56"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-56">&#182;</a></div><div class="doc"> array. In which case we would be looping over the element of the</div></td><td class="code"><div class="highlight"><pre class="brush: php"></pre></div></td></tr><tr id="section-57"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-57">&#182;</a></div><div class="doc"> array that we're actually trying to join. Since we only really</div></td><td class="code"><div class="highlight"><pre class="brush: php"></pre></div></td></tr><tr id="section-58"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-58">&#182;</a></div><div class="doc"> care about put together joins at this point if the element isn't</div></td><td class="code"><div class="highlight"><pre class="brush: php"></pre></div></td></tr><tr id="section-59"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-59">&#182;</a></div><div class="doc"> an object, then continue on our way.</div></td><td class="code"><div class="highlight"><pre class="brush: php"></pre></div></td></tr><tr id="section-60"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-60">&#182;</a></div><div class="doc"> It's all very meta.</div></td><td class="code"><div class="highlight"><pre class="brush: php">			if (is_array($join)) {
				continue;
			}
			if (func_num_args() == 1) {
				if ($join-&gt;foreign_table-&gt;identifier() == $identifier) {
					return $join;
				}
			}
			else if (func_num_args() == 2) {
				if ($join-&gt;primary_table-&gt;identifier() == $identifier &amp;&amp;
				   ($join-&gt;as == $name || 
					$join-&gt;foreign_table-&gt;table_name() == $name)) {
					return $join;
				}
			}
		}
		return FALSE;
	}</pre></div></td></tr><tr id="section-61"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-61">&#182;</a></div><div class="doc"> ------------------------------------------------------------------------</div></td><td class="code"><div class="highlight"><pre class="brush: php">	public function current_query() {
		return $this-&gt;_build_query();
	}
	public function last_query() {
		return @$this-&gt;queries[count($this-&gt;queries)-1]?:FALSE;
	}</pre></div></td></tr><tr id="section-62"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-62">&#182;</a></div><div class="doc"> ------------------------------------------------------------------------</div></td><td class="code"><div class="highlight"><pre class="brush: php">	
}
</pre></div></td></tr></table></div><script>converter = new Showdown.converter();$(".doc").each(function() { $(this).html(converter.makeHtml($(this).text())); }); $("#jump_handle").click(function(e){ $("#jump_wrapper").toggle(); e.preventDefault(); }); </script><script src="https://raw.github.com/alexgorbatchev/SyntaxHighlighter/master/scripts/XRegExp.js"></script><script src="https://raw.github.com/alexgorbatchev/SyntaxHighlighter/master/scripts/shCore.js" type="text/javascript"></script><script src="http://alexgorbatchev.com/pub/sh/current/scripts/shAutoloader.js" type="text/javascript"></script><script type="text/javascript">
function path()
{
  var args = arguments,
      result = []
      ;
       
  for(var i = 0; i < args.length; i++)
      result.push(args[i].replace("@", "http://alexgorbatchev.com/pub/sh/current/scripts/"));
       
  return result
};

SyntaxHighlighter.autoloader.apply(null, path(
  "applescript            @shBrushAppleScript.js",
  "actionscript3 as3      @shBrushAS3.js",
  "bash shell             @shBrushBash.js",
  "coldfusion cf          @shBrushColdFusion.js",
  "cpp c                  @shBrushCpp.js",
  "c# c-sharp csharp      @shBrushCSharp.js",
  "css                    @shBrushCss.js",
  "delphi pascal          @shBrushDelphi.js",
  "diff patch pas         @shBrushDiff.js",
  "erl erlang             @shBrushErlang.js",
  "groovy                 @shBrushGroovy.js",
  "java                   @shBrushJava.js",
  "jfx javafx             @shBrushJavaFX.js",
  "js jscript javascript  @shBrushJScript.js",
  "perl pl                @shBrushPerl.js",
  "php                    @shBrushPhp.js",
  "text plain             @shBrushPlain.js",
  "py python              @shBrushPython.js",
  "ruby rails ror rb      @shBrushRuby.js",
  "sass scss              @shBrushSass.js",
  "scala                  @shBrushScala.js",
  "sql                    @shBrushSql.js",
  "vb vbnet               @shBrushVb.js",
  "xml xhtml xslt html    @shBrushXml.js"
));
SyntaxHighlighter.defaults["light"] = true;
SyntaxHighlighter.defaults["unindent"] = false;
SyntaxHighlighter.all();
	</script></body>